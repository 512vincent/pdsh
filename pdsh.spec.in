Name: @PROJECT@
Version: @VERSION@
Release: @RELEASE@
Summary: Parallel remote shell program.
Copyright: none
Group: System Environment/Base
Source: %{name}-%{version}-%{release}.tgz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}
# Prereq: 

%define withmachines 0
%define withelan 1

%description
Pdsh is a multithreaded remote shell client which executes commands
on multiple remote hosts in parallel.  Pdsh can use several different remote
shell services, including standard "rsh", Kerberos IV, and ssh.

%package qshd
Summary: Remote shell daemon for pdsh/Elan3
Group: System Environment/Base
Prereq: xinetd
%description qshd
Remote shell service for running Quadrics Elan3 jobs under pdsh.
Sets up Elan capabilities and environment variables needed by Quadrics MPICH
executables.

%prep
%setup -n %{name}-%{version}-%{release}

%build

%if %withelan
WITHELAN=--with-elan
%endif
%if %withmachines
WITHMACHINES=--with-machines=/usr/local/etc/machines
%endif

./configure --prefix=/usr --with-readline $WITHELAN $WITHMACHINES
make

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/usr/bin
mkdir -p $RPM_BUILD_ROOT/usr/man/man1
install -s pdsh $RPM_BUILD_ROOT/usr/bin/pdcp
install -s pdsh $RPM_BUILD_ROOT/usr/bin/pdsh
cp dshbak $RPM_BUILD_ROOT/usr/bin/
gzip pdsh.1 pdcp.1 dshbak.1
cp pdsh.1.gz $RPM_BUILD_ROOT/usr/man/man1
cp pdcp.1.gz $RPM_BUILD_ROOT/usr/man/man1
cp dshbak.1.gz $RPM_BUILD_ROOT/usr/man/man1
%if %{chaos}
mkdir -p $RPM_BUILD_ROOT/etc/xinetd.d
mkdir -p $RPM_BUILD_ROOT/usr/sbin
cp qshell.xinetd $RPM_BUILD_ROOT/etc/xinetd.d/qshell
install -s in.qshd $RPM_BUILD_ROOT/usr/sbin/
%endif

%files
%defattr(-,root,root)
%doc README ChangeLog DISCLAIMER README.KRB4
%attr(4755, root, root) /usr/bin/pdsh
%attr(4755, root, root) /usr/bin/pdcp 
/usr/bin/dshbak
/usr/man/man1/pdsh.1.gz
/usr/man/man1/pdcp.1.gz
/usr/man/man1/dshbak.1.gz

%post
rm -f /var/cache/man/cat1/pdsh.1.*
rm -f /var/cache/man/cat1/pdcp.1.*

%if %{withelan}
%files qshd
%defattr(-,root,root)
/usr/sbin/in.qshd
/etc/xinetd.d/qshell

%post qshd
if ! grep "^qshell" /etc/services >/dev/null; then
        echo "qshell   523/tcp  # pdsh/elan3" >>/etc/services
fi
/etc/rc.d/init.d/xinetd reload
%endif
