#
# $Id$ 
#
PROJECT=	pdsh

SHELL=          @SHELL@
CC=             @CC@
DEFS=           @DEFS@
CFLAGS=         @CFLAGS@
LDFLAGS=        @LDFLAGS@
LIBS=           @LIBS@
RANLIB=         @RANLIB@
INSTALL=        @INSTALL@
LN_S=		@LN_S@
mkinstalldirs=  $(SHELL) $(top_srcdir)/auxdir/mkinstalldirs
@SET_MAKE@
COPTS=          $(CFLAGS) $(CPPFLAGS) $(DEFS)

AC_OUTPUT=	Makefile config.h pdsh.spec

top_srcdir=     @top_srcdir@
prefix=         @prefix@
exec_prefix=    @exec_prefix@
bindir=         @bindir@
sbindir=        @sbindir@
libdir=         @libdir@

ELAN_PROGS=	@ELAN_PROGS@

PDSH_OBJS=	list.o xmalloc.o xstring.o err.o xpopen.o \
		dsh.o main.o opt.o wcoll.o xrcmd.o sshcmd.o \
		k4cmd.o qswutil.o qcmd.o

QSHD_OBJS=	list.o xmalloc.o xstring.o err.o qswutil.o qshd.o 

PREFIX=		/usr/local

#
# if you wish to build with kerberos IV, uncomment these
# and set KRB4 to 1 in conf.h
#
#KRB_INC=	-I/usr/local/krb4/include
#KRB_LIB=	-L/usr/local/krb4/lib -lkrb -ldes
#KRB_OBJS=	k4cmd.o

#
# Uncomment and set HAVE_ELAN3 to 1 in conf.h for Quadrics Elan support
#
#ELAN_PROGS=	qshd
#ELAN_OBJS=	qswutil.o qcmd.o
#ELAN_LIB=	-lelan3 -lrmscall -lrmsapi -lrms

# Solaris
#LIBS =	-lpthread -lgen -lnsl -lsocket
# AIX 4.2
#LIBS =	-lbsd_r $(KRB_LIB) -lpthreads
# Linux RH 6.2, AIX 4.3.x, OSF
# LIBS = $(KRB_LIB)  -lpthread $(ELAN_LIB)

CPPFLAGS=	$(KRB_INC)

PROGS =	pdsh

all: pdsh $(ELAN_PROGS)

pdsh: $(PDSH_OBJS)
	$(CC) -o $@ $(PDSH_OBJS) $(LDFLAGS) $(LIBS)

qshd: $(QSHD_OBJS)
	$(CC) -o $@ $(QSHD_OBJS) $(LIBS)

qswutil_main.o: qswutil.c
	$(CC) -o $@ -c $(CFLAGS) -DTEST_MAIN qswutil.c

install: $(PROGS)
	$(mkinstalldirs) $(DESTDIR)$(bindir)
	$(INSTALL) -m 4755 -o root pdsh $(DESTDIR)$(bindir)/
	$(LN_S) $(DESTDIR)$(bindir)/pdsh $(DESTDIR)$(bindir)/pdcp
	$(INSTALL) dshbak $(DESTDIR)$(bindir)/
	$(INSTALL) pdsh.1 $(DESTDIR)$(mandir)/man1/
	$(INSTALL) pdcp.1 $(DESTDIR)$(mandir)/man1/
	$(INSTALL) dshbak.1 $(DESTDIR)$(mandir)/man1/

clean:
	-rm -f *.o *.a *~ \#* .\#* cscope*.out core core.* *.core tags TAGS

realclean: clean
	-rm -f $(PROGS)
	-rm -f *.tgz *.rpm

distclean: realclean
	-rm -f config.cache config.log config.status stamp-h Makefile.bak
	-rm -f $(AC_OUTPUT)

depend:
	-makedepend -Y -- $(COPTS) -- *.[ch] 2>/dev/null

tags: $(PROGS)
	-ctags * 2>/dev/null

include Make-rpm.mk

# AUTO-REMAKE OF AUTOCONF-RELATED TARGETS

Makefile: Makefile.in config.status
	./config.status

config.status: META
	./config.status --recheck

$(PROJECT).spec: $(PROJECT).spec.in
	./config.status $@

# DO NOT DELETE THIS LINE -- make depend depends on it.
